<!DOCTYPE html>
<html>
	<head>
		<meta charset="utf-8">
		<title>SquareForm</title>
		<script src="sprite_box.js" charset="utf-8"></script>
		<script src="gridMap_mod.js" charset="utf-8"></script>
		<script src="GameSetup.js" charset="utf-8"></script>
	</head>
	<body>
		<canvas>
			<script>
			setupGame(document.getElementsByTagName("Canvas")[0]);
			setCanvasSize(eCanvas);
			var Map = new GridMap();
	     		Map.w = eCanvas.width-1;
		    	Map.h = eCanvas.height-1;
				Map.setColorCode(0,"rgb(0, 0, 055)");
				Map.setColorCode(1,"Black");
				Map.setColorCode(2,"rgb(102, 102, 102)");
				Map.setColorCode(3,"rgb(139,69,19)");
				Map.drawSeparation = false;
			Map.setCellsValue([	
			[1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1],
			[1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1],
			[1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1],
			[1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,3,3,3,3,0,0,0,0,0,0,1],
			[1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,3,3,3,0,0,0,0,0,0,0,0,0,0,0,1],
			[1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1],
			[1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,3,3,3,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1],
			[1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1],
			[1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,3,3,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1],
			[1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1],
			[1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,3,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1],
			[1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,3,3,3,3,3,3,3,3,3,3,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1],
			[1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1],
			[1,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1],
			[1,0,0,0,1,1,1,1,1,1,1,1,1,1,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1],
			[1,0,0,2,2,2,2,2,2,2,2,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1],
			[1,1,1,2,2,2,2,2,2,2,2,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1],
			[1,2,2,2,1,1,2,1,1,2,2,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1],
			[1,2,2,2,2,2,2,2,2,2,2,2,2,2,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1],
			[1,2,2,2,1,2,2,2,2,2,1,1,1,1,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1],
			[1,2,2,2,1,1,1,2,2,2,2,2,2,2,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1],
			[1,2,2,2,2,2,2,2,2,2,2,2,2,2,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,1,2,2,0,0,0,1,0,0,0,2,0,0,0,1],
			[1,2,1,1,0,0,0,2,2,1,2,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,2,2,2,0,0,0,2,0,0,0,2,0,0,0,1],
			[1,2,2,1,0,0,0,2,2,1,2,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,2,2,2,0,0,0,2,0,0,0,2,0,0,0,1],
			[1,2,2,2,0,0,0,1,1,1,2,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,2,2,2,2,2,1,2,2,2,2,2,1,2,2,1],
			[1,1,2,2,2,2,2,2,2,2,2,2,2,2,1,2,2,2,2,2,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,2,2,2,2,2,2,2,2,2,2,2,2,2,2,1],
			[1,2,1,1,1,2,2,2,2,2,2,2,2,2,1,2,2,2,2,2,1,0,0,0,0,0,0,0,0,0,0,0,0,1,1,2,2,1,2,2,2,2,2,1,2,2,2,2,1,1],
			[1,2,2,1,2,2,2,2,2,2,2,2,2,2,1,1,2,2,2,2,1,0,0,0,0,0,0,0,0,0,0,0,0,1,2,2,2,1,2,2,2,2,2,2,2,2,2,2,2,1],
			[1,2,2,2,2,2,1,1,1,1,1,2,2,2,2,1,2,2,2,2,1,0,0,0,0,0,0,0,0,0,0,0,1,1,2,2,2,1,2,2,2,2,2,2,2,2,1,2,2,1],
			[1,2,2,2,0,0,0,2,2,2,2,0,0,0,2,1,1,1,2,2,1,0,0,0,0,0,0,0,0,0,0,2,2,1,2,2,2,1,2,2,2,2,2,2,2,2,2,2,2,1],
			[1,2,2,2,0,0,0,2,2,2,2,0,1,0,2,1,0,0,2,2,1,0,0,0,0,0,0,0,0,0,1,2,2,1,1,2,1,1,1,2,2,2,2,2,2,2,2,2,2,1],
			[1,2,2,2,0,0,0,2,2,2,2,0,0,0,2,1,0,0,2,2,1,0,0,0,0,0,0,0,0,0,2,2,2,2,1,2,1,2,0,0,0,2,0,0,2,0,0,0,1,1],
			[1,2,2,2,2,2,2,2,2,2,2,2,2,2,2,1,0,0,2,2,1,0,0,0,0,0,0,0,0,0,2,2,2,2,1,2,1,2,0,0,0,2,0,0,1,0,0,0,2,1],
			[1,2,2,1,2,2,1,2,2,2,2,2,2,2,1,1,0,0,2,2,1,0,0,0,0,0,0,0,0,0,2,2,2,2,1,2,1,2,0,0,0,2,0,0,2,0,0,0,2,1],
			[1,1,1,1,2,1,1,1,1,1,1,1,1,1,1,1,0,0,2,2,1,0,0,0,0,0,0,0,0,0,2,2,1,2,1,2,1,2,0,0,0,2,0,0,2,0,0,0,2,1],
			[1,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,1,0,0,0,0,0,0,0,0,0,2,2,2,2,1,2,1,2,1,1,1,1,1,1,1,2,2,1,2,1],
			[1,2,2,2,2,2,2,2,3,2,2,2,2,2,2,2,2,2,2,2,1,0,0,0,0,0,0,0,0,0,2,2,2,2,1,2,2,2,2,2,2,2,2,2,1,2,2,2,2,1],
			[1,1,2,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,0,0,0,0,0,0,0,0,0,2,2,2,2,1,2,2,2,2,2,2,2,2,2,1,2,2,2,2,1],
			[1,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,1,0,0,0,0,0,0,0,0,0,2,2,2,1,1,1,1,1,1,2,2,2,2,2,1,2,1,2,2,1],
			[1,2,1,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,1,0,0,0,0,0,0,0,0,0,2,2,2,2,1,0,0,0,2,2,2,2,2,2,2,2,2,2,2,1],
			[1,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,1,0,0,0,0,0,0,0,0,0,2,2,2,2,1,0,0,0,2,2,2,2,2,2,2,2,2,2,2,1],
			[1,1,2,0,0,0,2,0,0,0,2,0,0,0,2,0,0,0,2,2,1,0,0,0,0,0,0,0,0,0,2,2,1,2,1,0,0,0,2,2,2,2,2,2,1,1,1,1,1,1],
			[1,2,2,0,0,0,2,0,0,0,2,0,0,0,2,0,0,0,2,2,1,0,0,0,0,0,0,0,0,0,2,2,2,2,1,1,1,2,2,2,2,2,2,2,2,2,0,0,0,1],
			[1,1,1,0,0,0,2,0,0,0,2,0,0,0,2,0,0,0,2,2,1,0,0,0,0,0,0,0,0,0,2,2,2,2,1,2,2,2,2,2,1,1,1,2,2,2,0,0,0,1],
			[1,2,2,0,0,0,2,0,0,0,2,0,0,0,2,0,0,0,2,2,1,1,1,0,0,0,0,0,0,0,2,2,2,2,1,2,2,2,2,2,1,1,2,2,2,1,0,0,0,1],
			[1,2,2,1,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,0,0,0,0,0,0,0,2,2,2,1,1,2,2,2,1,2,1,1,2,2,2,2,0,0,0,1],
			[1,2,1,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,0,0,0,0,0,0,0,2,2,2,2,1,2,2,1,1,2,1,1,1,1,1,2,2,1,2,1],
			[1,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,0,0,0,0,0,0,0,2,2,2,2,1,2,1,1,1,2,2,1,2,2,1,2,2,2,2,1],
			[1,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,3,2,2,0,0,0,0,0,0,0,2,2,1,1,1,2,2,2,2,2,2,1,2,2,2,2,2,2,2,1],
			[1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1],

			]);
			Map.drawW = Map.h/Map.map.length;
			Map.drawH = Map.h/Map.map.length;
			Map.fullDraw = true;
			var cellCodes = [1,3];
			objects.push(Map);
			function makeBox(xx,yy){
				var box1 = new Sprite();
					box1.isBOX = true;
					box1.color = "rgb(128,128,0)";
					box1.w = Map.drawW;
					box1.h = Map.drawH;
					box1.x = xx;
					box1.y = yy;
					box1.accGravityY =1;
					box1.calculateCollisionPoints();
					box1.mainMove = box1.move;
					box1.move = function(dt){
						this.mainMove(dt);
						//Collision with Boxes
						
						
						//Collision with MAP
						var verticalDir = -1;
						if(this.vely>0){
							verticalDir = 3;
						}else if(this.vely<0){
							verticalDir = 7;
						}
						var adjustedCoodsGuy = {};
							adjustedCoodsGuy.x=this.x;
							adjustedCoodsGuy.y=this.y;
							adjustedCoodsGuy.velx=this.velx;
							adjustedCoodsGuy.vely=this.vely;
							adjustedCoodsGuy.w=this.w;
							adjustedCoodsGuy.h=this.h;
						if(Map.collisionInDirection(adjustedCoodsGuy,cellCodes,verticalDir)){//Gravity Collision
							this.y=this.y-this.vely;
							this.vely=0;
							if(verticalDir == 3){
								this.jumping = false;
							}
						}
						var horizontaldir = -1;
						if(this.velx>0){
							horizontaldir = 1;
						}else if(this.velx<0){
							horizontaldir = 5;
						}
						if(horizontaldir !=-1 && Map.collisionInDirection(adjustedCoodsGuy,cellCodes,horizontaldir)){//Gravity Collision
							this.x=this.x-this.velx;
							this.velx=0;
						}
					}
					return box1;
				}
			<!-- objects.push(makeBox(Map.getXYByCell(Map.getRowCount()-1,Map.getRowColCount(Map.getRowCount()-1)-2).mx,Map.getXYByCell(Map.getRowCount()-1,Map.getRowColCount(Map.getRowCount()-1)-2).my-10)); -->
			
			
			var guy = new Sprite();
				guy.jumping = false;
				guy.color = "yellow";
				guy.w = Map.drawW/8;
				guy.h = Map.drawH/8;
				guy.x = Map.getXYByCell(Map.getRowCount()-1,Map.getRowColCount(Map.getRowCount()-1)-2).mx;
				guy.y = Map.getXYByCell(Map.getRowCount()-1,Map.getRowColCount(Map.getRowCount()-1)-2).my-10;
				guy.accNaturalLimit = 1;
				guy.stopVelX = 9.5;
				guy.stopVelY = 9;		
				guy.calculateCollisionPoints();
				guy.accGravityY =1;
				guy.mainMove = guy.move;
				guy.maskW = Map.drawW/2;
				guy.maskH = Map.drawH/2;
				guy.move = function(dt){
					this.mainMove(dt);
					//Collision with Boxes
					for(var i =0;i<objects.length;i++){
						if(objects[i].isBOX){
							for(var j =0;j<objects.length;j++){
								var colx = objects[i].collisionPoints[j].x;
								var coly = objects[i].collisionPoints[j].y;
								if(this.circularColisionCheckByMask(objects[i].x+objects[i].velx+colx,objects[i].y+objects[i].vely+coly)){
									console.log("!");
								}
							}
						}
					}
					//Collision with MAP
					var verticalDir = -1;
					if(this.vely>0){
						verticalDir = 3;
					}else if(this.vely<0){
						verticalDir = 7;
					}
					var adjustedCoodsGuy = {};
						adjustedCoodsGuy.x=this.x;
						adjustedCoodsGuy.y=this.y;
						adjustedCoodsGuy.velx=this.velx;
						adjustedCoodsGuy.vely=this.vely;
						adjustedCoodsGuy.w=this.w;
						adjustedCoodsGuy.h=this.h;
					if(Map.collisionInDirection(adjustedCoodsGuy,cellCodes,verticalDir)){//Gravity Collision
						this.y=this.y-this.vely;
						this.vely=0;
						if(verticalDir == 3){
							this.jumping = false;
						}
					}
					var horizontaldir = -1;
					if(this.velx>0){
						horizontaldir = 1;
					}else if(this.velx<0){
						horizontaldir = 5;
					}
					if(horizontaldir !=-1 && Map.collisionInDirection(adjustedCoodsGuy,cellCodes,horizontaldir)){//Gravity Collision
						this.x=this.x-this.velx;
						this.velx=0;
					}
				}
			var ada1=0;
			var ada2=0;
			setLoopFunction(function(thi){
				ctx.translate(-thi[0].x*1.2,-thi[0].y*1.2);
				<!-- ctx.translate(thi[0].x,ada2); -->
				ctx.scale(2,2);
			},new Array(guy));
			objects.push(guy);
				setKeyFunction(87,'keydown',function(thi){//Jump
					if(!thi[0].jumping){
						thi[0].vely -= 75*deltaTime;
						thi[0].jumping = true;
					}
				},new Array(guy));
				//setKeyFunction(83,'keydown',function(thi){thi[0].accy += 10*deltaTime;},new Array(guy));//Can't go down, so we remove this line... it's here more for a completionist sake
				setKeyFunction(65,'keydown',function(thi){thi[0].accx -= 20*deltaTime;},new Array(guy));//Move Left
				setKeyFunction(68,'keydown',function(thi){thi[0].accx += 20*deltaTime;},new Array(guy));//Move Right
			
			mainLoop();
			</script>
		</canvas>
	</body>
</html>